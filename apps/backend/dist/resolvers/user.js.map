{"version":3,"sources":["../../src/resolvers/user.ts"],"sourcesContent":["import {\r\n  Arg,\r\n  createUnionType,\r\n  Ctx,\r\n  Field,\r\n  InputType,\r\n  Mutation,\r\n  Query,\r\n  Resolver,\r\n} from \"type-graphql\";\r\nimport argon2 from \"argon2\";\r\nimport { User } from \"@models/User\";\r\nimport { MyContext } from \"@typedefs/MyContext\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { validate } from \"class-validator\";\r\nimport { setToken } from \"@utils/setToken\";\r\nimport { ExistingUserError } from \"@errors/ExisitingUserError\";\r\nimport { FieldsValidationError } from \"@errors/FieldsValidationError\";\r\nimport { BadCredentialsError } from \"@errors/BadCredentialsError\";\r\nimport { NonExistingUserError } from \"@errors/NonUserExists\";\r\nimport { PrismaClientKnownRequestError } from \"@prisma/client/runtime\";\r\n\r\nexport const AuthResult = createUnionType({\r\n  name: \"AuthResult\",\r\n  types: () =>\r\n    [\r\n      User,\r\n      FieldsValidationError,\r\n      NonExistingUserError,\r\n      BadCredentialsError,\r\n    ] as const,\r\n});\r\n\r\nexport const CreateUserResult = createUnionType({\r\n  name: \"CreateUserResult\",\r\n  types: () => [User, FieldsValidationError, ExistingUserError] as const,\r\n});\r\n\r\n@InputType()\r\nexport class UsernamePasswordInput {\r\n  @Field()\r\n  firstName: string;\r\n  @Field()\r\n  lastName: string;\r\n  @Field()\r\n  password: string;\r\n  @Field()\r\n  email: string;\r\n}\r\n\r\n@Resolver()\r\nexport class UserResolver {\r\n  @Query(() => String)\r\n  async helloworld() {\r\n    return \"hello world\";\r\n  }\r\n  @Query(() => [User])\r\n  async getUsers(@Ctx() { prisma, res }: MyContext) {\r\n    return prisma.user.findMany({});\r\n  }\r\n  @Query(() => [User])\r\n  async getUser(@Ctx() { prisma, res }: MyContext) {\r\n    return prisma.user.findFirst({});\r\n  }\r\n\r\n  @Mutation((_type) => CreateUserResult)\r\n  async signup(\r\n    @Arg(\"options\") options: UsernamePasswordInput,\r\n    @Ctx() { prisma, res }: MyContext\r\n  ) {\r\n    const errors = await validate(options);\r\n    if (errors.length > 0) return FieldsValidationError.from(errors);\r\n    const hashedPassword = await argon2.hash(options.password);\r\n\r\n    try {\r\n      const createdUser = await prisma.user.create({\r\n        data: {\r\n          ...options,\r\n          experience: \"Beginner\",\r\n          password: hashedPassword,\r\n        },\r\n      });\r\n\r\n      await prisma.account.create({\r\n        data: {\r\n          userId: createdUser.id,\r\n          type: \"credentials\",\r\n          provider: \"Credentials\",\r\n          providerAccountId: createdUser.id,\r\n        },\r\n      });\r\n\r\n      setToken(createdUser, res);\r\n\r\n      return {\r\n        user: createdUser,\r\n      };\r\n    } catch (err) {\r\n      if (\r\n        err instanceof PrismaClientKnownRequestError &&\r\n        err.code === \"P2002\" // unique constraint failed\r\n      ) {\r\n        return new ExistingUserError();\r\n      } else {\r\n        throw err;\r\n      }\r\n    }\r\n  }\r\n  @Mutation((_type) => AuthResult)\r\n  async signin(\r\n    @Arg(\"usernameOrEmail\") usernameOrEmail: string,\r\n    @Arg(\"password\") password: string,\r\n    @Ctx() { prisma, res, req }: MyContext\r\n  ) {\r\n    const user = await prisma.user.findUnique({\r\n      where: {\r\n        email: usernameOrEmail,\r\n      },\r\n    });\r\n\r\n    if (!user) return new NonExistingUserError();\r\n\r\n    const authenticated = await argon2.verify(user.password, password);\r\n\r\n    if (!authenticated) return new BadCredentialsError();\r\n\r\n    setToken(user, res);\r\n\r\n    req.session.userId = user.id;\r\n\r\n    return {\r\n      user: user,\r\n    };\r\n  }\r\n}\r\n"],"names":["AuthResult","createUnionType","name","types","User","FieldsValidationError","NonExistingUserError","BadCredentialsError","CreateUserResult","ExistingUserError","UsernamePasswordInput","Field","firstName","lastName","password","email","InputType","UserResolver","helloworld","getUsers","prisma","res","user","findMany","getUser","findFirst","signup","options","errors","validate","length","from","hashedPassword","argon2","hash","createdUser","create","data","experience","account","userId","id","type","provider","providerAccountId","setToken","err","PrismaClientKnownRequestError","code","signin","usernameOrEmail","req","findUnique","where","authenticated","verify","session","Query","String","Ctx","Mutation","_type","Arg","Resolver"],"mappings":"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"}