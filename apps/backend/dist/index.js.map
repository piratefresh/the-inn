{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import \"reflect-metadata\";\r\nimport { COOKIE_NAME, __prod__ } from \"./constants\";\r\nimport { buildSchema } from \"type-graphql\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nimport { UserResolver } from \"./resolvers/user\";\r\nimport express from \"express\";\r\nimport Redis from \"ioredis\";\r\nimport cors from \"cors\";\r\nimport session from \"express-session\";\r\nimport connectRedis from \"connect-redis\";\r\nimport { ApolloServer } from \"apollo-server-express\";\r\n\r\nimport { ApolloServerPluginLandingPageGraphQLPlayground } from \"apollo-server-core\";\r\n\r\nexport const prisma = new PrismaClient({\r\n  log: [\"query\"],\r\n});\r\n\r\nconst startServer = async () => {\r\n  const PORT = 4000;\r\n  const app: express.Application = (module.exports = express());\r\n  const RedisStore = connectRedis(session);\r\n  const redis = new Redis({\r\n    host: \"theinn.redis.cache.windows.net\",\r\n    port: 6380,\r\n    password: \"xpkqdr9nlXOUBVCXkrMbHihzDvVitpQaJAzCaIve6YY=\",\r\n    tls: true as any,\r\n  });\r\n\r\n  app.use(\r\n    cors({\r\n      origin: [\r\n        \"http://localhost:3000\",\r\n        \"https://the-inn-graphql.vercel.app/\",\r\n        \"https://the-inn-server.herokuapp.com/\",\r\n        \"https://the-inn.herokuapp.com/\",\r\n      ],\r\n      credentials: true,\r\n    })\r\n  );\r\n\r\n  const sessionMiddleware = session({\r\n    name: COOKIE_NAME,\r\n    store: new RedisStore({ client: redis, disableTouch: true }),\r\n    cookie: {\r\n      maxAge: 1000 * 60 * 60 * 24 * 365 * 10, // 10 years\r\n      httpOnly: true,\r\n      sameSite: \"lax\", // csrf\r\n      secure: __prod__, // cookie only works in https\r\n    },\r\n    saveUninitialized: false,\r\n    secret: \"keyboard cat\",\r\n    resave: false,\r\n  });\r\n\r\n  app.use(sessionMiddleware);\r\n\r\n  const apolloServer = new ApolloServer({\r\n    schema: await buildSchema({\r\n      resolvers: [UserResolver],\r\n      validate: false,\r\n      //   pubSub: pubsub,\r\n    }),\r\n    context: async ({ req, res }) => {\r\n      return {\r\n        prisma,\r\n        req,\r\n        res,\r\n      };\r\n    },\r\n    plugins: [ApolloServerPluginLandingPageGraphQLPlayground()],\r\n    introspection: true,\r\n  });\r\n\r\n  await apolloServer.start();\r\n\r\n  apolloServer.applyMiddleware({\r\n    app,\r\n    cors: false,\r\n  });\r\n\r\n  app.listen(PORT, () => {\r\n    console.log(\r\n      `ðŸš€ Server ready at http://localhost:${PORT}${apolloServer.graphqlPath}`\r\n    );\r\n    // console.log(\r\n    //   `ðŸš€ Subscriptions ready ws://localhost:${PORT}${apolloServer.subscriptionsPath}`\r\n    // );\r\n  });\r\n};\r\n\r\nstartServer().catch((err) => {\r\n  console.error(err);\r\n});\r\n"],"names":["prisma","PrismaClient","log","startServer","PORT","app","module","exports","express","RedisStore","connectRedis","session","redis","Redis","host","port","password","tls","use","cors","origin","credentials","sessionMiddleware","name","COOKIE_NAME","store","client","disableTouch","cookie","maxAge","httpOnly","sameSite","secure","__prod__","saveUninitialized","secret","resave","apolloServer","ApolloServer","schema","buildSchema","resolvers","UserResolver","validate","context","req","res","plugins","ApolloServerPluginLandingPageGraphQLPlayground","introspection","start","applyMiddleware","listen","console","graphqlPath","catch","err","error"],"mappings":"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"}